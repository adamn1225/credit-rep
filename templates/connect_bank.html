{% extends "base.html" %}

{% block title %}Connect Bank Account - Credit Repair Pro{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>üè¶ Bank Account Connections</h2>
                <button id="linkButton" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Connect New Bank
                </button>
            </div>
            
            <!-- Benefits Card -->
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <h5 class="card-title">üí° Why Connect Your Bank?</h5>
                    <ul class="mb-0">
                        <li><strong>Automatic Account Discovery:</strong> Import accounts to dispute</li>
                        <li><strong>Payment Proof:</strong> Find transactions proving you paid creditors</li>
                        <li><strong>Verification:</strong> Prove account ownership for disputes</li>
                        <li><strong>Secure:</strong> Bank-level encryption via Plaid</li>
                    </ul>
                </div>
            </div>
            
            <!-- Connected Banks -->
            {% if plaid_items %}
            <h4>Connected Banks</h4>
            <div class="row">
                {% for item in plaid_items %}
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">
                                        üè¶ {{ item.institution_name or 'Bank Connection' }}
                                    </h5>
                                    <p class="text-muted small mb-2">
                                        Connected: {{ item.created_at[:10] if item.created_at else 'Unknown' }}
                                    </p>
                                    <p class="text-muted small mb-0">
                                        Last Synced: {{ item.last_sync[:10] if item.last_sync else 'Never' }}
                                    </p>
                                </div>
                                <div>
                                    <span class="badge bg-success">Active</span>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary sync-btn" 
                                        data-item-id="{{ item.id }}">
                                    <i class="bi bi-arrow-repeat"></i> Sync Now
                                </button>
                                <button class="btn btn-sm btn-outline-danger disconnect-btn" 
                                        data-item-id="{{ item.id }}">
                                    <i class="bi bi-x-circle"></i> Disconnect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No banks connected yet. Click "Connect New Bank" to get started!
            </div>
            {% endif %}
            
            <!-- How It Works -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">üîê Security & Privacy</h5>
                </div>
                <div class="card-body">
                    <p>We use <strong>Plaid</strong>, a trusted financial services company used by Venmo, Coinbase, and thousands of other apps.</p>
                    <ul>
                        <li>‚úÖ Your login credentials are encrypted and never stored by us</li>
                        <li>‚úÖ Bank-level 256-bit encryption</li>
                        <li>‚úÖ Read-only access to your accounts</li>
                        <li>‚úÖ You can disconnect anytime</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plaid Link SDK -->
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let linkHandler = null;
    
    // Initialize Plaid Link
    async function initializePlaidLink() {
        try {
            // Get link token from backend
            const response = await fetch('/api/plaid/create-link-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Create Plaid Link handler
            linkHandler = Plaid.create({
                token: data.link_token,
                onSuccess: async function(public_token, metadata) {
                    // Exchange public token for access token
                    try {
                        const exchangeResponse = await fetch('/api/plaid/exchange-token', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                public_token: public_token
                            })
                        });
                        
                        const result = await exchangeResponse.json();
                        
                        if (result.success) {
                            alert(`‚úÖ Successfully connected! Imported ${result.accounts_imported} account(s).`);
                            location.reload();
                        } else {
                            alert('Error: ' + result.error);
                        }
                    } catch (error) {
                        alert('Error connecting bank: ' + error.message);
                    }
                },
                onExit: function(err, metadata) {
                    if (err != null) {
                        console.error('Plaid Link error:', err);
                    }
                }
            });
            
        } catch (error) {
            alert('Error initializing Plaid: ' + error.message);
        }
    }
    
    // Connect bank button
    document.getElementById('linkButton').addEventListener('click', async function() {
        if (!linkHandler) {
            await initializePlaidLink();
        }
        if (linkHandler) {
            linkHandler.open();
        }
    });
    
    // Sync buttons
    document.querySelectorAll('.sync-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const itemId = this.getAttribute('data-item-id');
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
            
            try {
                const response = await fetch(`/api/plaid/sync-accounts/${itemId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Synced ${result.accounts_synced} account(s) and ${result.transactions_synced} transaction(s)!`);
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error syncing: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sync Now';
            }
        });
    });
    
    // Disconnect buttons
    document.querySelectorAll('.disconnect-btn').forEach(button => {
        button.addEventListener('click', async function() {
            if (!confirm('Are you sure you want to disconnect this bank? All transaction data will be deleted.')) {
                return;
            }
            
            const itemId = this.getAttribute('data-item-id');
            
            try {
                const response = await fetch(`/api/plaid/disconnect/${itemId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Bank disconnected successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error disconnecting: ' + error.message);
            }
        });
    });
});
</script>
{% endblock %}
